<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Escanear Pulsera</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        background-image: url('./fondo.jpg');
        background-size: cover;
        background-position: center;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        font-family: Arial, sans-serif;
        color: white;
        text-shadow: 0px 0px 6px black;
    }

    #boton-scan {
        padding: 15px 30px;
        background: rgba(0,0,0,0.7);
        border: 2px solid white;
        border-radius: 20px;
        font-size: 22px;
        color: white;
        font-weight: bold;
        backdrop-filter: blur(3px);
    }

    #numeroMesa {
        margin-top: 20px;
        font-size: 50px;
        display: none;
        animation: estrellas 1.2s ease-out forwards;
    }

    @keyframes estrellas {
        0% { opacity: 0; transform: scale(0.5); }
        50% { opacity: 1; transform: scale(1.3); }
        100% { opacity: 1; transform: scale(1); }
    }

    #reader {
        width: 90%;
        max-width: 400px;
        margin-top: 20px;
        display: none;
    }
</style>
</head>

<body>

<button id="boton-scan">ðŸ“· ESCANEAR QR</button>

<div id="reader"></div>

<h1 id="numeroMesa"></h1>

<audio id="audio" src="./bienvenida.mp3"></audio>

<script>
    const boton = document.getElementById("boton-scan");
    const readerDiv = document.getElementById("reader");
    const textoMesa = document.getElementById("numeroMesa");
    const audio = document.getElementById("audio");

    let html5QrCode = null;
    let scannerActivo = false;

    document.addEventListener("touchstart", () => {
        audio.load();
    }, { once: true });

    boton.addEventListener("click", () => {

        textoMesa.style.display = "none";

        // Si ya hay un lector creado, detenerlo y crear uno nuevo
        if (scannerActivo && html5QrCode) {
            html5QrCode.stop().catch(()=>{}).finally(() => {
                iniciarScanner();
            });
        } else {
            iniciarScanner();
        }
    });

    function iniciarScanner() {
        readerDiv.style.display = "block";
        scannerActivo = true;

        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            qrCodeMessage => {

                html5QrCode.stop().then(() => {

                    readerDiv.style.display = "none";
                    scannerActivo = false;

                    textoMesa.innerText = qrCodeMessage;
                    textoMesa.style.display = "block";

                    audio.play().catch(err => console.log("Error audio:", err));

                }).catch(err => console.log("No se pudo detener:", err));
            },
            error => {}
        );
    }
</script>

</body>
</html>
