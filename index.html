<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Scanner QR - Pulseritas</title>

  <!-- html5-qrcode (CDN) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <style>
    :root{
      --accent: #f6c84c;
      --text: #111;
      --glass: rgba(255,255,255,0.12);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: #000;
      color:var(--text);
    }

    /* Fondo completo con la imagen que pondr√°s en la ra√≠z (fondo.jpg) */
    .page {
      min-height:100%;
      background-image: url('fondo.jpg');
      background-size: cover;
      background-position: center center;
      display:flex;
      align-items:flex-end; /* bot√≥n al centro-bajo en m√≥vil */
      justify-content:center;
      padding: 24px;
      box-sizing:border-box;
      position:relative;
    }

    /* capa oscura sutil para mejor contraste del bot√≥n */
    .overlay {
      position:absolute;
      inset:0;
      background: linear-gradient(to top, rgba(0,0,0,0.45), rgba(0,0,0,0.08));
      pointer-events:none;
    }

    /* Bot√≥n elegante */
    .scan-btn {
      position:relative;
      z-index:20;
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px 20px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      color: white;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.4px;
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 6px 24px rgba(0,0,0,0.45), 0 2px 8px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      width:100%;
      max-width:420px;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease;
      user-select:none;
    }
    .scan-btn:active { transform: translateY(2px) scale(.995); }
    .scan-btn .icon {
      width:34px;
      height:34px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(0,0,0,0.2), rgba(255,255,255,0.02));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
    }

    /* contenedor del lector (video) - se muestra encima cuando escanea */
    #reader {
      position:fixed;
      inset:0;
      z-index:30;
      display:none; /* visible s√≥lo al escanear */
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.75);
      padding:12px;
      box-sizing:border-box;
    }
    #reader .camera-wrap {
      width:100%;
      max-width:720px;
      height:60vh;
      max-height:880px;
      background: #111;
      border-radius:14px;
      overflow:hidden;
      position:relative;
    }
    .close-reader {
      position:absolute;
      top:12px;
      right:12px;
      z-index:40;
      background:rgba(255,255,255,0.06);
      color:white;
      border-radius:10px;
      padding:8px 10px;
      font-weight:600;
      cursor:pointer;
    }

    /* Overlay del n√∫mero escaneado */
    .numero-overlay {
      position:fixed;
      left:50%;
      top:28%;
      transform:translate(-50%, -50%) scale(0.95);
      z-index:40;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:14px;
      padding:18px 22px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      backdrop-filter: blur(6px);
      text-align:center;
      min-width:60%;
      max-width:92%;
    }

    .numero-overlay h1 {
      margin:0;
      font-size: clamp(28px, 10vw, 72px);
      letter-spacing:4px;
      color:var(--accent);
      text-shadow: 0 6px 18px rgba(0,0,0,0.6), 0 0 18px rgba(246,200,76,0.16);
      font-weight:900;
    }

    .numero-overlay p {
      margin:0;
      color: #fff;
      font-weight:600;
      opacity:0.95;
      font-size:14px;
    }

    /* Estrellitas animadas */
    .stars {
      position:absolute;
      inset: unset;
      width:100%;
      height:100%;
      top:0;
      left:0;
      pointer-events:none;
      overflow:visible;
    }

    .star {
      position:absolute;
      font-size:14px;
      color:var(--accent);
      transform-origin:center;
      opacity:0;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.45));
      animation: starPop 1.4s ease forwards;
    }

    @keyframes starPop {
      0% { opacity:0; transform: translate3d(0,0,0) scale(.1) rotate(0deg); }
      30% { opacity:1; transform: translate3d(var(--dx), var(--dy),0) scale(1.2) rotate(140deg); }
      70% { opacity:0.8; transform: translate3d(calc(var(--dx) * .6), calc(var(--dy) * .6),0) scale(.9) rotate(260deg); }
      100% { opacity:0; transform: translate3d(calc(var(--dx) * 1), calc(var(--dy) * 1),0) scale(0) rotate(540deg); }
    }

    /* mensajes y ayuda */
    .hint {
      margin-top:12px;
      color: rgba(255,255,255,0.9);
      font-size:13px;
      text-align:center;
      z-index:20;
      max-width:420px;
    }

    /* Responsive tweaks */
    @media(min-width:900px){
      .page { align-items:center; }
      .scan-btn { max-width:300px; }
      #reader .camera-wrap { height:70vh; }
      .numero-overlay { top:40%; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="overlay" aria-hidden="true"></div>

    <!-- Bot√≥n principal -->
    <button id="scanBtn" class="scan-btn" aria-label="Sacanear QR">
      <span class="icon">üì∑</span>
      <span>SACANEAR QR</span>
    </button>

    <div class="hint">Toc√° el bot√≥n y acerc√° la pulserita al rect√°ngulo de la c√°mara.</div>
  </div>

  <!-- lector c√°mara (oculto hasta iniciar) -->
  <div id="reader" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="camera-wrap" id="cameraWrap">
      <div id="html5qr-reader" style="width:100%;height:100%"></div>
      <button id="closeReader" class="close-reader">Cerrar ‚úï</button>
    </div>
  </div>

  <!-- overlay del n√∫mero escaneado -->
  <div id="numeroOverlay" class="numero-overlay" role="status" aria-live="polite">
    <div class="stars" id="starsContainer"></div>
    <h1 id="numeroGrande">00</h1>
    <p>Tu n√∫mero de mesa</p>
    <button id="okBtn" class="scan-btn" style="max-width:220px; padding:10px 14px;">
      OK
    </button>
  </div>

  <!-- audio (en la ra√≠z: bienvenida.mp3 y bienvenida1.mp3 si quer√©s variantes) -->
  <audio id="audioGood" src="bienvenida.mp3" preload="auto"></audio>
  <!-- si quer√©s un audio alternativo por n√∫mero -->
  <audio id="audioGoodAlt" src="bienvenida1.mp3" preload="auto"></audio>

  <script>
    // Elementos
    const scanBtn = document.getElementById('scanBtn');
    const readerWrap = document.getElementById('reader');
    const html5qrRegionId = "html5qr-reader";
    const closeReader = document.getElementById('closeReader');
    const numeroOverlay = document.getElementById('numeroOverlay');
    const numeroGrande = document.getElementById('numeroGrande');
    const starsContainer = document.getElementById('starsContainer');
    const okBtn = document.getElementById('okBtn');
    const audioGood = document.getElementById('audioGood');
    const audioGoodAlt = document.getElementById('audioGoodAlt');

    // Estado
    let html5QrCode = null;
    let isScanning = false;

    function showReader() {
      readerWrap.style.display = 'flex';
      readerWrap.setAttribute('aria-hidden','false');
    }
    function hideReader() {
      readerWrap.style.display = 'none';
      readerWrap.setAttribute('aria-hidden','true');
    }
    function showNumeroOverlay(num) {
      numeroGrande.textContent = num;
      numeroOverlay.style.display = 'flex';
      // crear estrellitas aleatorias
      spawnStars();
      // animaci√≥n peque√±o pop al overlay
      numeroOverlay.animate([{ transform: 'translate(-50%,-50%) scale(.9)', opacity: 0 }, { transform: 'translate(-50%,-50%) scale(1)', opacity:1 }], { duration: 450, easing: 'cubic-bezier(.2,.9,.2,1)' });
    }
    function hideNumeroOverlay() {
      numeroOverlay.style.display = 'none';
      starsContainer.innerHTML = '';
    }

    function spawnStars() {
      starsContainer.innerHTML = '';
      // generar entre 6 y 12 estrellas con posiciones y desplazamientos aleatorios
      const n = Math.floor(Math.random() * 7) + 6;
      for (let i=0; i<n; i++){
        const s = document.createElement('div');
        s.className = 'star';
        s.textContent = '‚òÖ';
        // posici√≥n inicial dentro del overlay
        const left = Math.random() * 90 + 5; // %
        const top = Math.random() * 60 + 10; // %
        s.style.left = left + '%';
        s.style.top = top + '%';
        // desplazamientos personalizados via variables CSS
        const dx = (Math.random() * 140 - 70) + 'px';
        const dy = (Math.random() * -140 - 30) + 'px';
        s.style.setProperty('--dx', dx);
        s.style.setProperty('--dy', dy);
        // different delays
        s.style.animationDelay = (Math.random() * 0.35) + 's';
        s.style.fontSize = (10 + Math.random()*28) + 'px';
        starsContainer.appendChild(s);
      }
    }

    // iniciar escaneo con html5-qrcode
    async function startScanner() {
      if (isScanning) return;
      isScanning = true;
      showReader();

      // config de la c√°mara y lector
      const config = { fps: 20, qrbox: { width: Math.min(window.innerWidth, 360) } };

      try {
        html5QrCode = new Html5Qrcode(html5qrRegionId, /* verbose= */ false);

        // preferimos la camara trasera
        const constraints = { facingMode: "environment" };

        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          qrCodeSuccessCallback
        );
      } catch (err) {
        console.error("No se pudo iniciar la c√°mara:", err);
        alert("No se pudo acceder a la c√°mara. Verific√° permisos o prob√° en otro navegador.");
        stopScanner();
      }
    }

    // cuando se detecta QR
    function qrCodeSuccessCallback(decodedText, decodedResult) {
      // decodedText es lo que figura en el QR. Suponemos que contiene el n√∫mero de mesa (p.ej "18" o "15Doris")
      // Parar lector
      stopScanner();

      // limpiar string y extraer el n√∫mero (si viene con texto)
      let resultado = decodedText + "";
      // si el QR trae texto con letras y n√∫mero, intentamos extraer n√∫mero m√°s grande
      const match = resultado.match(/\d+/g);
      let numero = resultado;
      if (match && match.length>0) {
        numero = match.join('');
      }

      // mostrar overlay con n√∫mero y reproducir audio
      showNumeroOverlay(numero);

      // reproducir audio seg√∫n n√∫mero (ejemplo: si viene "15Doris" usamos audio alternativo)
      if (/15Doris/i.test(resultado)) {
        audioGoodAlt.play().catch(()=>{/*ignore*/});
      } else {
        audioGood.play().catch(()=>{/*ignore*/});
      }

      // actualizar Scan button texto
      scanBtn.textContent = "Nuevo QR";
    }

    // parar y liberar c√°mara
    async function stopScanner(){
      if (!isScanning) return;
      isScanning = false;
      try {
        if (html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
          html5QrCode = null;
        }
      } catch(e){ console.warn("Error parando html5QrCode", e); }
      hideReader();
    }

    // eventos UI
    scanBtn.addEventListener('click', async (e)=>{
      // si el texto est√° "Nuevo QR" limpiamos overlay y reiniciamos
      if (scanBtn.textContent.trim().toLowerCase() === "nuevo qr") {
        hideNumeroOverlay();
        scanBtn.textContent = "SACANEAR QR";
        return;
      }
      // start
      startScanner();
    });

    closeReader.addEventListener('click', ()=>{
      stopScanner();
    });

    okBtn.addEventListener('click', ()=>{
      hideNumeroOverlay();
      // dejar el bot√≥n listo para nuevo QR
      scanBtn.textContent = "Nuevo QR";
    });

    // si usuario cierra pesta√±a o navega, asegurar detener c√°mara
    window.addEventListener('pagehide', ()=> { stopScanner(); });

    // Accessibility: permitir Enter/Space en el bot√≥n principal
    scanBtn.addEventListener('keydown', (ev)=>{
      if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); scanBtn.click(); }
    });
  </script>
</body>
</html>
